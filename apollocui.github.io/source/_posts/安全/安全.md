---
layout: post
title: 服务器被攻击处理过程
date: 2021-06-15 11:00:00
tags:
    - [ cpu异常 ]
categories:
    - [ 安全 ]
#password: cbb4693
---
## 故障现象
服务器故障现象

```
xshell登录不了服务器，直接卡死
服务器CPU 负载很高，有一个进程cpu进程达到一千多，top -c 查看异常进程command 是bash, kill 命令杀死进程一会自动拉起, 如下图:
```
<img src="/images/安全/top-process.jpg" width=100% height=50% align=left/>

## 处理过程
1.先修改用户密码和ssh端口，计划任务 
 
```
更改服务器ssh端口，和root 普通用户密码
检查当前进程使用root 账户启动，查看root 计划任务(/etc/crontab和crontab -l) 是否有异常计划任务
```

2.查看日志 

```
内核及公共消息日志：/var/log/messages
计划任务日志：/var/log/cron
系统引导日志：/var/log/dmesg
邮件服务日志：/var/log/maillog
用户登录验证日志：/var/log/secure
最近用户登录日志：/var/log/lastlog
用户登录日志：/var/log/wtmp（该文件是二进制文件，不能用cat、tail等命令访问，而是通过last和lastlog命令来调用）
```

3.用systemctl status 查看异常进程，如下图

```
用systemctl status 有两个异常进程:phtunnel和pwnrigl 用systemd 管理的，kill该进程自动拉起，如下图:
```
<img src="/images/安全/异常进程.jpg" width=100% height=50% align=left/>
<img src="/images/安全/pwnrigl.jpg" width=100% height=50% align=left/>
<img src="/images/安全/phtunnel.jpg" width=100% height=50% align=left/>

## 攻击脚本内容
```
systemctl cat pwnrig.service
# Automatically generated by systemd-sysv-generator

[Unit]
Documentation=man:systemd-sysv-generator(8)
SourcePath=/etc/rc.d/init.d/pwnrig
Description=SYSV: pwnrig (by pwned)
Before=runlevel2.target
Before=runlevel3.target
Before=runlevel4.target
Before=runlevel5.target
Before=shutdown.target
After=network-online.target
After=network.service
Conflicts=shutdown.target

[Service]
Type=forking
Restart=no
TimeoutSec=5min
IgnoreSIGPIPE=no
KillMode=process
GuessMainPID=no
RemainAfterExit=yes
ExecStart=/etc/rc.d/init.d/pwnrig start
ExecStop=/etc/rc.d/init.d/pwnrig stop

cat /tmp/pwnrig
#!/bin/bash
#
# pwnrig          Start/Stop the pwnrig clock daemon.
#
# chkconfig: 2345 90 60
# description: pwnrig (by pwned)
cp -f -r -- /bin/initdr /bin/-bash 2>/dev/null
cd /bin 2>/dev/null
./-bash -c  2>/dev/null
rm -rf -- -bash 2>/dev/null
```
## 结果
```
先关闭这两个服务和开机自启动:
systemctl stop pwnrigl && systemctl disable pwnrigl
把这两个服务从:/usr/lib/systemd/system/下面移除，并执行syetemctl daemon-reload 服务器CPU和负载恢复正常

```
## 总结pwnrige挖矿病毒
### 开机自启动清理
````
rc0.d/    rc1.d/    rc2.d/    rc3.d/    rc4.d/    rc5.d/    rc6.d/    rc.d/     rc.local
````
<img src="/images/安全/pwnrigl-rc.jpg" width=100% height=30% align=left/>
### 计划任务清理
````
find / -name pwnrig   #扫描根目录
cron.d/       cron.daily/   cron.deny     cron.hourly/  cron.monthly/ crontab       cron.weekly/  #查看目录下文件
crontab -l  #查看计划任务
````
<img src="/images/安全/pwnrigl-process.jpg" width=100% height=20% align=left/>

###  检查环境变量是否病毒脚本
````
/etc/profile
/etc/profile.d/*
~/.bash_profile
````

### 检查systemd 文件目录
````
/etc/systemd/system/
/run/systemd/
/usr/lib/systemd/system/
````
