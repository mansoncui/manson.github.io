---
title: 自动化运维
date: 2019-06-11 16:42:21
tags:
    - [ saltstack ]
categories:
    - [ 自动化运维 ]
---

## Saltstack 部署安装
```
环境:关闭firewalld，iptables，selinux,设置dns或者hosts解析
     python 版本: 2.7 <= python < 3
     master和slave设置hosts解析:
     192.168.1.117 saltstack-master
     192.168.1.118 saltstack-slave

####安装saltstack

服务端安装:
yum  -y  install  epel-release
yum  -y  install  salt-master salt-minion 

服务端配置修改:
# vim /etc/salt/minion                   //在第16行添加，冒号后有一个空格
master: saltstack-master

客户端安装:
yum  -y  install  epel-release
yum  -y  install  salt-minion

客户端配置修改:
# vim /etc/salt/minion                   //在第16行添加，冒号后有一个空格
master: saltstack-master

客户端和服务端启动服务:
service salt-master start #只有服务端安装了该服务
service salt-minion start #服务端和客户端都安装此服务

配置认证:
服务端操作:
salt-key -a  saltstack-master
salt-key -a  saltstack-slave
salt-key

说明：-a ：accept ，-A：accept-all，-d：delete，-D：delete-all。可以使用 salt-key 命令查看到已经签名的客户端。此时我们在客户端的 /etc/salt/pki/minion 目录下面会多出一个minion_master.pub 文件

测试验证:
示例1： salt '*' test.ping                  //检测通讯是否正常，也可以指定其中一个 'saltstack-master'

示例2:  salt '*' cmd.run   'df -h'        //远程执行命令
```
---
## Saltstack 错误总结
```
1、错误信息 Minion did not return. [Not connected]
删除客户端公钥:rm -rf /etc/salt/pki/minion/minion_master.pub
service salt-minion restart #重启client服务  

2、错误信息:Failed building wheel for uwsgi
yum -y install python-devel（python2.7）
```
---
## Pdsh
```
##pdsh安装##
yum  -y  install  gcc gcc-c++ perl-devel readline-devel bzip2 #安装依赖

下载源码包:https://sourceforge.net/projects/pdsh/files/latest/download

tar -xjvf pdsh-2.26.tar.bz2

cd  pdsh-2.26 

./configure --prefix=/usr/local/globle/softs/tools/pdsh/2.26/ --with-timeout=60 --with-ssh --with-exec --with-nodeupdown --with-readline --with-machines=/etc/pdsh/machines  --with-dshgroups 

make  &&  make  install

参数详解:
   选项	                    解释
--prefix	            指定安装目录
--with-timeout=60	    指定pdsh默认执行超时时间
--with-ssh	            编译ssh模块
--with-exec	            编译exec模块
--with-nodeupdown	    编译节点宕机功能
--with-readline	            编译readline功能
--with-rcmd-rank-list	    指定默认模式为ssh
--with-machines	            指定默认主机列表
--with-dshgroups            调用组-g选项(默认文件位置:/root/.dsh/group/userhosts or /etc/dsh/group/userhosts)

把pdsh安装机器公钥存放到个远端服务器/root/.ssh/authorized_keys 

ln -s /usr/local/pdsh/bin/pdsh /usr/sbin/pdsh #设置软连接
```